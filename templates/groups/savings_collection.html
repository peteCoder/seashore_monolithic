{% extends 'layouts/base.html' %}
{% load humanize %}

{% block title %}Savings Collection - {{ group.name }} - Seashore Microfinance{% endblock %}
{% block page_title %}Savings Collection{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="savingsCollectionApp()">
    <!-- Breadcrumb -->
    <div class="mb-6">
        <div class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400 mb-2">
            <a href="{% url 'core:group_list' %}" class="hover:text-primary-600 dark:hover:text-primary-400">
                <i class="fas fa-layer-group mr-1"></i>Groups
            </a>
            <span>/</span>
            <a href="{% url 'core:group_detail' group.id %}" class="hover:text-primary-600 dark:hover:text-primary-400">{{ group.name }}</a>
            <span>/</span>
            <span class="text-gray-900 dark:text-white font-medium">Savings Collection</span>
        </div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">
            <i class="fas fa-piggy-bank text-green-600 dark:text-green-400 mr-2"></i>
            Savings Deposit Collection
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-1">Collect savings deposits from group members</p>
    </div>

    <!-- Group Info Card -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Group Name</p>
                <p class="text-base font-semibold text-gray-900 dark:text-white">{{ group.name }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 font-mono">{{ group.code }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Meeting Day</p>
                <p class="text-base font-semibold text-gray-900 dark:text-white">{{ group.get_meeting_day_display }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Active Members</p>
                <p class="text-base font-semibold text-gray-900 dark:text-white">{{ group.active_members }} / {{ group.total_members }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Total Group Savings</p>
                <p class="text-lg font-bold text-green-600 dark:text-green-400">&#8358;{{ total_savings|floatformat:2|intcomma }}</p>
            </div>
        </div>
    </div>

    <form method="post" action="{% url 'core:group_savings_collection_post' group.id %}" @submit="return validateForm()">
        {% csrf_token %}

        <!-- Total Amount Collected -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-money-bill-wave text-green-600 dark:text-green-400 mr-2"></i>Total Cash Received
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Total Amount Collected <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 font-medium">&#8358;</span>
                        <input type="number" name="total_amount_collected" x-model="totalCollected" step="0.01" min="0" required
                               placeholder="Enter total cash received from group"
                               class="w-full pl-8 pr-4 py-3 border rounded-lg shadow-sm text-lg font-semibold focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white transition-colors"
                               :class="totalMismatch() ? 'border-red-500 dark:border-red-500 bg-red-50 dark:bg-red-900/10' : 'border-gray-300 dark:border-gray-600'">
                    </div>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        Enter the total amount of savings cash the staff physically received from the group
                    </p>
                </div>
                <div class="flex items-center">
                    <div class="w-full p-4 rounded-lg border-2 transition-colors"
                         :class="totalMismatch() ? 'border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/20' : 'border-green-300 dark:border-green-700 bg-green-50 dark:bg-green-900/20'">
                        <p class="text-sm font-medium" :class="totalMismatch() ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'">
                            <i class="fas" :class="totalMismatch() ? 'fa-exclamation-triangle' : 'fa-check-circle'"></i>
                            <span x-text="totalMismatch() ? 'Totals do not match!' : 'Totals match'"></span>
                        </p>
                        <div class="mt-2 space-y-1">
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                Sum of individual amounts: <span class="font-bold">&#8358;<span x-text="formatNumber(calculateSum())"></span></span>
                            </p>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                Total collected entered: <span class="font-bold">&#8358;<span x-text="formatNumber(parseFloat(totalCollected) || 0)"></span></span>
                            </p>
                            <template x-if="totalMismatch() && parseFloat(totalCollected) > 0">
                                <p class="text-sm font-semibold" :class="getDifference() > 0 ? 'text-red-600 dark:text-red-400' : 'text-orange-600 dark:text-orange-400'">
                                    Difference: &#8358;<span x-text="formatNumber(Math.abs(getDifference()))"></span>
                                    <span x-text="getDifference() > 0 ? '(over-allocated)' : '(under-allocated)'"></span>
                                </p>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collection Settings -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                <i class="fas fa-cog text-primary-600 dark:text-primary-400 mr-2"></i>Collection Settings
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Payment Method <span class="text-red-500">*</span>
                    </label>
                    <select name="payment_method" x-model="paymentMethod" required
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        <option value="cash">Cash</option>
                        <option value="bank_transfer">Bank Transfer</option>
                        <option value="mobile_money">Mobile Money</option>
                        <option value="cheque">Cheque</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Collection Date <span class="text-red-500">*</span>
                    </label>
                    <input type="date" name="payment_date" x-model="paymentDate" required value="{{ today }}"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                        Reference (Optional)
                    </label>
                    <input type="text" name="payment_reference" x-model="paymentReference" placeholder="Transaction reference"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500">
                </div>
            </div>
        </div>

        <!-- Members & Savings Accounts Table -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden mb-6">
            <div class="px-6 py-4 bg-gray-50 dark:bg-gray-900/50 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                        <i class="fas fa-list text-primary-600 dark:text-primary-400 mr-2"></i>Members with Active Savings Accounts
                    </h2>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        <span x-text="getFilledCount()"></span> member(s) with amounts entered |
                        Sum: &#8358;<span x-text="formatNumber(calculateSum())"></span>
                    </p>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" @click="clearAllAmounts()"
                            class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors font-medium">
                        <i class="fas fa-eraser mr-1"></i>Clear All
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-900/50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">#</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Member</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Account Number</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Current Balance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Amount to Deposit</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% for data in member_savings_data %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                            :class="parseFloat(amounts['{{ data.account.id }}']) > 0 ? 'bg-green-50/50 dark:bg-green-900/10' : ''">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ forloop.counter }}</td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ data.client.get_full_name }}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">{{ data.client.client_id }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-mono font-medium text-gray-900 dark:text-white">{{ data.account.account_number }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <span class="text-sm font-bold text-green-600 dark:text-green-400">&#8358;{{ data.account.current_balance|floatformat:2|intcomma }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="relative">
                                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400 dark:text-gray-500">&#8358;</span>
                                    <input type="number"
                                           name="amount_{{ data.account.id }}"
                                           x-model="amounts['{{ data.account.id }}']"
                                           step="0.01"
                                           min="0"
                                           placeholder="0.00"
                                           class="w-36 pl-6 pr-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500 text-sm">
                                </div>
                                <input type="hidden" name="account_{{ data.account.id }}" value="{{ data.account.id }}">
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                                <i class="fas fa-inbox text-4xl mb-3 block"></i>
                                <p class="text-lg font-medium">No members with active savings accounts</p>
                                <p class="text-sm mt-1">Members need to have active savings accounts before deposits can be collected.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if member_savings_data %}
                    <tfoot class="bg-gray-50 dark:bg-gray-900/50">
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-right text-sm font-bold text-gray-900 dark:text-white">
                                Total Sum of Amounts:
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-lg font-bold" :class="totalMismatch() ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'">
                                    &#8358;<span x-text="formatNumber(calculateSum())"></span>
                                </span>
                            </td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Notes -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                <i class="fas fa-sticky-note text-gray-400 mr-1"></i>Collection Notes (Optional)
            </label>
            <textarea name="notes" rows="3" placeholder="Any notes about this savings collection session..."
                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg shadow-sm focus:ring-primary-500 focus:border-primary-500"></textarea>
        </div>

        <!-- Validation Warning -->
        <template x-if="totalMismatch() && parseFloat(totalCollected) > 0 && calculateSum() > 0">
            <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 mb-6 rounded-r-lg">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-400 text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-red-800 dark:text-red-300">Amount Mismatch Warning</h3>
                        <p class="text-sm text-red-700 dark:text-red-300 mt-1">
                            The total amount collected (&#8358;<span x-text="formatNumber(parseFloat(totalCollected) || 0)"></span>)
                            does not match the sum of individual deposit amounts (&#8358;<span x-text="formatNumber(calculateSum())"></span>).
                            Please verify the amounts before submitting.
                        </p>
                    </div>
                </div>
            </div>
        </template>

        <!-- Submit Section -->
        {% if member_savings_data %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Collection Summary</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <span x-text="getFilledCount()"></span> deposit(s) totalling
                        <span class="font-bold text-green-600 dark:text-green-400">&#8358;<span x-text="formatNumber(calculateSum())"></span></span>
                    </p>
                </div>
                <div class="flex items-center space-x-3">
                    <a href="{% url 'core:group_detail' group.id %}"
                       class="px-6 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium">
                        Cancel
                    </a>
                    <button type="submit"
                            :disabled="calculateSum() <= 0"
                            :class="calculateSum() <= 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-700'"
                            class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold transition-colors shadow-sm">
                        <i class="fas fa-paper-plane mr-2"></i>Submit Savings Collection
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </form>

    <!-- Recent Savings Collection Sessions -->
    {% if recent_sessions %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                <i class="fas fa-history text-gray-400 mr-2"></i>Recent Savings Collection Sessions
            </h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900/50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Collected By</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Action</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for s in recent_sessions %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                            {{ s.collection_date|date:"M d, Y" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">
                            {{ s.collected_by.get_full_name }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white text-right">
                            &#8358;{{ s.total_amount|floatformat:2|intcomma }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full
                                {% if s.status == 'approved' %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300
                                {% elif s.status == 'pending' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300
                                {% elif s.status == 'rejected' %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300
                                {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                                {% if s.status == 'approved' %}<i class="fas fa-check-circle mr-1"></i>
                                {% elif s.status == 'pending' %}<i class="fas fa-clock mr-1"></i>
                                {% elif s.status == 'rejected' %}<i class="fas fa-times-circle mr-1"></i>{% endif %}
                                {{ s.get_status_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                            <a href="{% url 'core:group_savings_session_detail' s.id %}"
                               class="text-primary-600 dark:text-primary-400 hover:text-primary-800 dark:hover:text-primary-300 font-medium">
                                <i class="fas fa-eye mr-1"></i>View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
function savingsCollectionApp() {
    return {
        totalCollected: '',
        amounts: {
            {% for data in member_savings_data %}
            '{{ data.account.id }}': '',
            {% endfor %}
        },
        paymentMethod: 'cash',
        paymentDate: '{{ today }}',
        paymentReference: '',

        calculateSum() {
            let total = 0;
            for (const key in this.amounts) {
                const val = parseFloat(this.amounts[key]);
                if (!isNaN(val) && val > 0) {
                    total += val;
                }
            }
            return Math.round(total * 100) / 100;
        },

        totalMismatch() {
            const collected = parseFloat(this.totalCollected) || 0;
            const sum = this.calculateSum();
            if (collected === 0 && sum === 0) return false;
            if (collected === 0 || sum === 0) return false;
            return Math.abs(collected - sum) > 0.01;
        },

        getDifference() {
            return this.calculateSum() - (parseFloat(this.totalCollected) || 0);
        },

        getFilledCount() {
            let count = 0;
            for (const key in this.amounts) {
                const val = parseFloat(this.amounts[key]);
                if (!isNaN(val) && val > 0) count++;
            }
            return count;
        },

        clearAllAmounts() {
            for (const key in this.amounts) {
                this.amounts[key] = '';
            }
            this.totalCollected = '';
        },

        formatNumber(num) {
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        },

        validateForm() {
            if (this.calculateSum() <= 0) {
                alert('Please enter at least one deposit amount.');
                return false;
            }
            if (this.totalMismatch()) {
                return confirm('The total amount collected does not match the sum of individual amounts. Do you want to submit anyway?');
            }
            return true;
        }
    }
}
</script>
{% endblock %}
